# 东方格斗编年史 - 项目开发状态文档

## 项目概述
东方格斗编年史是一个基于三国杀游戏机制的多人在线卡牌游戏，采用Kotlin Multiplatform Mobile (KMM)架构开发，支持实时对战和观战功能。

## 技术架构

### 前端 (Android App)
- **框架**: Jetpack Compose + MVVM架构
- **网络通信**: Ktor WebSocket客户端
- **状态管理**: StateFlow + Coroutines
- **序列化**: Kotlinx Serialization

### 后端 (Ktor Server)
- **框架**: Ktor WebSocket服务器
- **语言**: Kotlin
- **并发处理**: Coroutines + Mutex
- **数据存储**: 内存存储 (ConcurrentHashMap)

### 共享模块 (Shared)
- **数据模型**: 统一的游戏数据结构
- **消息协议**: 客户端-服务器通信协议
- **卡牌系统**: 完整的卡牌定义和效果

## 已完成功能

### 1. 网络通信系统 ✅
- **WebSocket连接管理**
  - 自动重连机制
  - 连接状态指示器
  - 服务器地址配置
  - 断线重连支持

- **实时消息同步**
  - 房间状态实时更新
  - 玩家操作同步广播
  - 游戏状态变化通知

### 2. 房间管理系统 ✅
- **房间创建与加入**
  - 房间创建功能
  - 房间ID加入
  - 房间列表查看
  - 房间信息展示

- **玩家管理**
  - 玩家重连机制 (同名视为同一玩家)
  - 玩家顺序调整
  - 最大8人房间支持

- **观战系统**
  - 观战者加入房间
  - 观战者重连
  - 游戏进行中观战
  - 观战模式UI

### 3. 用户界面系统 ✅
- **响应式布局**
  - 滚动支持解决界面操作问题
  - 房间ID截断防止按钮重叠
  - 优化的按钮布局和尺寸

- **游戏界面组件**
  - 游戏大厅界面
  - 房间信息卡片
  - 玩家状态卡片
  - 连接状态栏
  - 服务器设置对话框

- **交互优化**
  - 条件显示服务器状态 (仅在异常时显示)
  - 直观的游戏状态指示
  - 用户友好的错误提示

### 4. 完整三国杀游戏系统 ✅

#### 4.1 身份系统
- **身份分配**: 主公、忠臣、反贼、内奸
- **人数适配**: 支持5-8人不同身份配置
- **身份显示**: UI中显示玩家身份信息

#### 4.2 武将系统
- **武将库**: 内置经典武将 (张飞、关羽、赵云、马超、黄月英)
- **技能系统**: 主动技能、被动技能、触发技能
- **血量调整**: 根据武将自动调整血量上限

#### 4.3 完整卡牌系统
- **标准牌库**: 108张标准三国杀卡牌
- **基本牌**: 杀、闪、桃
- **锦囊牌**: 
  - 普通锦囊: 决斗、火攻、无中生有、过河拆桥等
  - 延时锦囊: 乐不思蜀、闪电
- **装备牌**: 武器、防具、攻击马、防御马

#### 4.4 卡牌效果系统
- **CardEffectService**: 专门的卡牌效果处理服务
- **多目标支持**: 支持单目标、多目标、全体目标卡牌
- **装备管理**: 装备穿戴、替换、效果计算
- **摸牌机制**: 自动洗牌、弃牌堆管理

#### 4.5 游戏流程控制
- **阶段系统**: 摸牌阶段、出牌阶段、弃牌阶段
- **回合管理**: 自动回合切换、玩家行动提示
- **游戏开始**: 身份分配、武将选择、初始手牌发放
  - 主公: 6张手牌
  - 其他角色: 4张手牌

### 5. 装备系统 ✅
- **装备区域**: 独立的装备展示区域
- **装备类型**: 
  - 武器 (红色): 增加攻击距离
  - 防具 (蓝色): 提供防护效果  
  - 攻击马 (绿色): 减少攻击距离
  - 防御马 (绿色): 增加被攻击距离
- **视觉效果**: 不同装备类型颜色区分
- **效果显示**: 装备数值效果展示

### 6. 卡牌目标选择系统 ✅
- **智能目标选择器**
  - 根据卡牌targetType自动判断是否需要目标选择
  - 支持单目标 (🎯)、多目标 (🎯+)、全体 (🌟💫) 选择
  - 目标验证和确认机制

- **卡牌视觉指示**
  - 卡牌上显示目标类型图标
  - 直观的目标选择界面
  - 玩家生命值信息展示

- **使用逻辑优化**
  - 无目标卡牌直接使用
  - 需要目标的卡牌弹出选择界面
  - 手牌正确消耗机制

### 7. 游戏数据管理 ✅
- **状态同步**: 完整的游戏状态实时同步
- **数据持久化**: 玩家名称、服务器地址、房间ID本地存储
- **内存管理**: 高效的游戏数据结构设计

## 技术特性

### 架构优势
- **模块化设计**: 清晰的三层架构 (UI/ViewModel/Service)
- **类型安全**: 完全基于Kotlin的类型安全实现
- **响应式编程**: StateFlow响应式状态管理
- **跨平台支持**: KMM架构支持Android/iOS扩展

### 性能优化
- **并发处理**: Coroutines异步处理提升性能
- **内存优化**: 高效的数据结构和状态管理
- **网络优化**: WebSocket长连接减少延迟
- **UI优化**: Compose声明式UI提升渲染效率

### 可维护性
- **清晰的代码结构**: 功能模块化，职责分离
- **类型安全**: Kotlinx Serialization确保数据安全
- **错误处理**: 完善的异常捕获和用户提示
- **可扩展设计**: 支持后续功能扩展

## 核心代码结构

```
TouhouBrawlChronicles/
├── app/                           # Android客户端
│   └── src/main/java/moe/gensoukyo/tbc/
│       ├── ui/
│       │   └── GameScreen.kt      # 主UI界面 (1800+ 行)
│       ├── viewmodel/
│       │   └── GameViewModel.kt   # MVVM视图模型
│       └── data/
│           └── PreferencesManager.kt # 本地数据存储
├── server/                        # Ktor服务器
│   └── src/main/kotlin/moe/gensoukyo/tbc/server/
│       ├── service/
│       │   ├── GameService.kt     # 核心游戏逻辑
│       │   └── CardEffectService.kt # 卡牌效果处理
│       └── websocket/
│           └── GameWebSocket.kt   # WebSocket通信
└── shared/                        # 共享模块
    └── src/main/kotlin/moe/gensoukyo/tbc/shared/
        ├── model/
        │   └── GameModels.kt      # 游戏数据模型
        ├── messages/
        │   └── Messages.kt        # 通信协议
        └── card/
            └── CardFactory.kt     # 卡牌工厂
```

## 游戏特色功能

### 1. 智能重连系统
- 同名玩家自动识别为重连
- 保持游戏状态和手牌
- 观战者重连支持

### 2. 实时观战功能
- 游戏进行中可加入观战
- 完整游戏状态展示
- 独立观战模式UI

### 3. 灵活房间管理
- 支持房间满员后自动转为观战
- 玩家顺序动态调整
- 房间信息详细展示

### 4. 完整三国杀体验
- 标准三国杀规则实现
- 108张标准卡牌完整支持
- 身份、武将、装备系统

### 5. 用户体验优化
- 滚动界面解决操作问题
- 条件显示减少界面冗余
- 直观的卡牌目标选择

## 开发里程碑

1. **基础架构搭建** ✅
2. **网络通信实现** ✅ 
3. **UI界面优化** ✅
4. **房间系统完善** ✅
5. **观战功能实现** ✅
6. **完整游戏系统** ✅
7. **装备系统集成** ✅
8. **目标选择系统** ✅

## 项目统计

- **代码总量**: 约8000+ 行
- **主要文件**: 
  - GameScreen.kt: 1800+ 行 (UI)
  - GameService.kt: 350+ 行 (服务器逻辑)
  - GameModels.kt: 170+ 行 (数据模型)
- **支持功能**: 完整三国杀游戏机制
- **技术特性**: 实时多人对战 + 观战

## 下一步开发计划

### 待开发功能
- [ ] 武将技能效果实现
- [ ] 游戏胜负判定
- [ ] 更多卡牌效果
- [ ] 游戏记录系统
- [ ] 用户账号系统
- [ ] 游戏统计功能

### 技术优化
- [ ] 数据库持久化
- [ ] 服务器集群部署
- [ ] 客户端缓存优化
- [ ] 网络异常恢复
- [ ] 性能监控

---

**文档版本**: v1.0  
**更新时间**: 2025-01-13  
**项目状态**: 核心功能完成，可进行完整三国杀游戏体验